import sys, pygame
from Config import Config
import Constants as C
from Robot import Robot
from collision_managment import create_environment, render_environment
import numpy as np
from math import sqrt
import json
import Debug

config=Config()
#SET THE WEIGHTS JSON STRING AND CHOOSE THE ROOM HERE, THEN RUN
vals = [
    '[[[-0.6921441307062257, -0.2598362885841148, 0.5325857969810179, 0.365445239007433], [-0.09191814637032802, -0.7177343456510907, 0.47685835147251865, 0.21840893653593585], [0.7386692197708857, 0.6330851030772049, -0.3503402465892711, -0.7799820463129581], [-0.5915458782522225, 0.3124458320375596, 0.5064733670476651, -0.43334735524643886], [0.8527611511285809, -0.0648492367768232, -0.018742964210088697, 0.8144125200654144], [0.47411710646093597, 0.7742227695595119, 0.8326671081352106, 0.44937932019270965], [-0.6675861486372778, -0.41789447579471006, 0.28096082821578605, -0.9986857097157715], [-0.21244330995229976, -0.5430033942585542, -0.18984686724610667, 0.13495556581621226], [0.4122853122856698, -0.6851625120049529, -0.4411451387858314, 0.28663094238541054], [0.2411949059298606, -0.5063027002535496, -0.27765129021884016, 0.20945898598558865], [0.261218600767394, -0.28623323592174454, 0.8062428417212668, 0.47329749360256], [-0.22987536354335458, -0.7457501645778262, 0.47569047241667883, -0.8131820522412054], [0.7546935684896225, 0.38651722487089946, 0.5576066404157625, 0.2360045580527943], [0.4807094374238208, -0.7651661178759874, -0.45751004601238265, 0.0828851623219693], [0.6279030312709628, -0.9105738985101368, -0.44726167178337106, -0.9900986511265484], [-0.5375993675470065, 0.2568537797869572, 0.06338801308420705, -0.4310014776777822], [-0.23326897258219237, 0.04050977593409777, -0.9251758927372102, 0.8853528270536486]], [[-0.21023293065478077, -0.29165129590203454], [0.6074572390091977, 0.9819292016401118], [-0.8591886419852344, -0.6017519569733913], [-0.6453039847143938, 0.3194175891074642]]]',
    #'[[[-5.477190952092632, 3.1560674133871154, 1.450908104077002, 11.384064544079074], [3.604689084577182, 6.616539428521521, -5.845187437432216, 1.301321654891528], [-0.09939038405121758, -3.266604409478619, -1.9193377498501358, -0.4331689875089355], [-7.338198802086274, 13.50935908405908, 3.318254831743804, -6.351355391799858], [-0.7807990764929842, -0.2260706842868565, -3.948612760617196, 3.4760117873830563], [-2.254010185863162, -12.821911251476061, 9.655413669700128, -5.983648596609879], [6.043601919740306, -0.6169420773406946, 8.157644471466613, -7.396416187912268], [-3.803805737847272, 0.12399109220214544, 1.386656829456225, -8.847444625801167], [1.540424409354444, 1.8212660310466817, 0.278601967130228, -6.407101483612761], [-9.73367261290947, 5.612084925928796, 9.941465128255363, 7.610900528778318], [-2.026262602836078, -10.69002561331113, -9.24440846046023, -1.796369024835338], [-5.0915321761962575, -3.3078922725544504, -4.326232439514846, 6.24043967683686], [-1.717471225405199, 9.298760950791614, -2.5252441162336354, -2.668124284672588], [2.687069291228534, -1.8379921188541775, -0.3904668483844985, 9.647576533181407], [-11.188787904464423, -8.43888506043031, 7.012227340671954, 3.0117341369769073], [3.870638553386777, -6.147864002904826, -9.625564729062637, -1.140453310674679], [10.705134370380962, 2.9256888143661053, -9.372976272606284, -8.460819418801416]], [[-7.158926802735468, -1.9648950913735526], [-7.994951897045961, -0.35380700027565537], [-5.7260934751414005, -6.097361389591051], [6.845289508826223, -4.6642266409982245]]]',
    '[[[-2.6864948627682246, 4.123497863227303, 7.386459894442061, 16.968251990345646], [-3.6133476934201747, 8.281918325655484, -12.70031843485081, -5.9898130165970525], [-4.562089686368322, 1.9192151759344127, 4.484293151006474, 18.395474572110423], [0.5113088559552732, 7.990533957229468, 3.2551430083447053, -8.133650458090287], [4.416896283336565, 23.513694599542916, 6.366923355803649, 1.6494335400839344], [6.54609377935202, -11.5533066026615, 10.161112908415294, -20.311332070520006], [7.812363282667091, 8.118916432388842, 10.998052083612, -15.78493162609265], [-4.979186593582143, -6.979791931233619, 1.579775769004135, -7.27405880799424], [-4.412410478832545, -4.042954621235388, 8.317477750385752, -14.586803657644024], [-10.973436317839392, 7.742761847582091, 27.254020533404095, 8.26231498297854], [-0.5669472642430493, 4.62390481913292, -20.726093391670435, 26.58839473298303], [-2.306911079033076, -5.5295254643610425, 0.4943414995817006, 15.677136912329454], [-4.794836876446153, 3.057139150148789, 5.581766794201312, 14.92497652452987], [-2.2406461316449677, -7.474678828421123, 3.0860959875314617, 16.654013862048824], [-13.088533516183354, -17.83040432345153, 3.8858601760638676, -2.71457345739101], [5.546973407683459, -7.751877392146287, -2.6824285940510766, -11.265847546913411], [8.99828886976176, -0.7322156454314279, 8.096836619855502, -11.026499301925483]], [[-1.2730700767098362, 0.9138973215230278], [-20.24312262424796, 2.581924400820739], [-14.02290171809973, -27.91138277724048], [16.43220139477549, -5.944675165140362]]]',
    #'[[[0.8460497397622856, 0.9925903532866072, 11.047531767401933, 23.12160769332824], [-14.56133328925336, -2.821208156205885, -9.246494366718444, -12.720719917066319], [-1.5051358844033356, 13.835131210975225, -0.7408895358691487, 8.83304250518543], [-0.8503777849842681, -0.2937414305191483, 0.9999466350949049, -8.739318283148643], [-6.2783393554738876, 13.000279149408536, 6.2039733632497684, 15.528031023446319], [11.137574249785642, -17.240156472942047, 10.22918115890781, -30.457616465340664], [8.13227398538175, 13.870810507664078, 20.544623860629194, -21.21284271381465], [-14.644417627145053, -0.895956897706014, 6.810108817041097, -7.907118153752211], [-3.198680438106572, -6.11784104459177, 2.4382167696545043, -12.95481906251108], [-9.216467475645533, 3.4283555170315245, 25.11025251329292, 8.995570867499744], [-9.366877767262043, 1.3434534584371183, -15.362077083499454, 33.48452876218407], [1.6470927609825141, -7.177865555598625, -6.819893872463718, 15.357757216663014], [1.5927879356213062, -5.224290313666518, 16.27014482452868, 10.348936482167458], [0.5209952276257848, -5.2040823148468345, -3.4676128150004875, 10.239060218355833], [-13.221666953019458, -8.298148326541924, 4.530579342606661, -6.584428581954178], [8.591772007937957, -17.127442660400842, -12.93331183652574, 0.9112234871857259], [5.335016018744125, 11.605537709852939, -1.2124813366924894, -3.287633981262139]], [[-1.5370019716284187, 1.4485907004146623], [-13.816197702482274, -3.1504390509439046], [-11.337658776648132, -9.539439299020883], [11.281836727159217, -7.49236842163419]]]',
    '[[[6.722802933445798, 12.146919875342375, 1.1685438918488347, 21.693169899834864], [-17.25706436913691, 0.02628539205282654, -7.212774387629923, -10.339902325175304], [-0.23673794876076915, 21.846684459128102, -1.4539042290486992, 3.992400996136712], [1.6853582934553644, -7.728851598496757, 8.48424009212424, -4.1876147055522335], [0.35703660610617804, 9.470272329947523, 4.194639850435827, 12.47433383474096], [20.080920515660193, -20.33738517359868, 24.717207690712716, -33.41543522848944], [9.465734293486092, 19.43265753464038, 18.16764273757983, -15.74476000588761], [-9.873753960047118, 6.094443873182136, 10.356193245114211, 7.17755153948198], [-0.740514681322841, -4.229063833799256, 0.15864266516778214, -10.87108112375202], [-21.97057741970035, 0.168230462206981, 18.9596036624475, 12.048382500657848], [-12.792260112974303, 4.002367400736178, -14.66401068615296, 33.87461346737324], [6.669114960092688, -4.7624647916420475, 0.20972604896979172, 16.186157122262387], [-8.841295302934276, -0.18952682684025945, 17.83825892116799, 8.953752050900652], [-6.859479061047564, -5.39061518931028, -8.431516545889515, 12.412081465337526], [-24.254196398875614, 5.670113075523284, 13.188070890678759, -0.1313671648719974], [-10.105808073503017, -16.34947914445603, -9.214781401803144, -5.391670139583502], [-2.009579546526025, 20.620026485930985, -0.3995079231900982, 2.994789735560878]], [[2.123450183370606, 4.110968014439206], [-15.055317848382659, -0.3379914046062402], [-12.356602556984303, -18.2986761467155], [18.603879114434285, -8.826274160090717]]]',
    #'[[[10.650957678338642, 5.7769131634531705, 1.0986475477715807, 24.676731756763164], [-18.609024722831787, 10.854618492738702, -14.633742796869484, -9.134630256721218], [4.9701998010678805, 0.6704517200081554, 7.16228322235879, 22.285476749747072], [18.59420746492238, -16.45481497040756, -1.4173245526668885, -2.683923429408355], [-2.8865294948471933, 12.138795979720568, 16.096244705124626, 15.184501441704802], [-3.842735970688573, -41.678746512388756, 39.92708275033809, -26.81243967951971], [13.281319702638768, 20.85372310856511, 12.636926500870691, -17.590111591393423], [-4.159901644123847, -11.836646222735377, 6.6773974133715726, 8.165095684979107], [-3.9425089960211213, 9.149846771718034, 12.358378564027731, -16.20277709881604], [-33.59402995165194, -6.0415198386536915, 17.861697349121442, 12.744206632969894], [-15.459208281298348, 9.521644369760885, -10.10024287842989, 33.43018891000434], [3.275713812383551, 4.978378679250733, -3.308300426743048, 20.633647174325386], [-14.585014617804811, 11.785349232128175, 23.824355110141305, 30.586822973502958], [-10.42231029124845, -4.038129798974279, 2.823554702306091, 21.672911289958567], [-18.076129641258824, 8.360942953137036, 18.243058311756535, -8.018135273061489], [-12.989643833200278, -22.63817572293726, -11.970299536509748, -8.098537341950305], [-8.007672943213322, 19.338252684223313, 0.2127981501947649, 6.7683131362954825]], [[5.997201839355697, -0.7938922023033371], [-15.672435893159943, 9.053845594954657], [-17.342818109175195, -23.313817096330208], [7.078885875544538, -10.62095821311626]]]',
    '[[[7.96638959736146, 15.220673510424113, 3.5940868875966565, 14.600844779669666], [-19.490777974272554, 10.035972963895322, -17.354138075427343, -7.523451802727337], [3.9390420469111858, 1.7981923293460753, 6.821111110120565, 15.560875271397652], [17.340997277874294, -14.21711249788363, 3.366394524769234, -0.8188303605583598], [-11.879899349760255, -4.537055023166654, 5.7935656722583815, 14.469462238451582], [8.75680166496697, -30.431343169093072, 35.94774078288374, -25.57892413199788], [27.401738279119765, 34.41823783790178, 16.355920660791824, -25.420717438484427], [-15.48088512816998, -5.288883191074297, 16.052296000695783, -3.110997337512711], [-2.793685964412849, 2.932889233673306, 16.31371997597888, -17.604210798126918], [-25.835892945982618, 12.689627173567889, 13.901698707828968, -1.8294516743825027], [-10.798599736122698, 7.073930591071273, -17.07896679295302, 38.75946230866551], [2.2687749856681436, 10.791356617245222, -2.29680293665766, 27.934292769685094], [-7.260187920596024, 7.046268637720269, 26.00862541925507, 28.005834421723964], [-22.40318424565667, -6.356055573731357, -6.076789349053562, 24.363384871872675], [-21.266282389452567, 14.19873649416364, 12.72614431462351, -3.266019977796851], [-9.453650759518718, -25.725482020646943, -1.4421136211492498, 1.0681331531727807], [-9.812474705152331, 17.039205515073558, -6.448686443792505, 9.288739309152147]], [[-0.8171947020669384, -13.05548437214269], [-16.385006992119944, 7.397586846918573], [-11.147832287075104, -23.23694717942528], [19.311182168956687, -6.218052893127531]]]',
    #'[[[-4.786545112190675, 19.2128397265047, 15.157923935260172, 9.39269239322952], [-30.846998673642528, 16.648681154343667, -23.35973835644209, -9.438046603362295], [8.74003954851787, 10.342371893878344, -1.2497402359706131, 18.077658597170082], [24.80689633703228, -3.2186839340909685, 5.980621015776885, 5.749212933381443], [-16.488436628719295, -5.873523101107964, 6.04878462862419, 23.347334315437756], [3.814703252841853, -24.860187748854855, 32.87685289230776, -23.270665222522485], [21.957719204774758, 34.98515949703679, 17.163534161880467, -18.807747858916166], [-6.526499966238848, 0.11714889297836906, 25.5878898744439, -8.255516193251399], [4.953632097850164, -0.3051225662245668, 12.158866721673235, -24.831993325409012], [-28.64473249311985, 7.4405554744478515, 19.138678140536417, 6.461059801228469], [-2.520675531402534, -0.3104276978098033, -3.9404999504188325, 38.353080040224945], [8.27189396606586, 10.902441234885568, -3.8303970919208212, 28.01513509775558], [-9.700493036616521, 10.10321537298146, 28.873658218443534, 27.164427145128425], [-24.695581352986498, -21.837016180818093, -18.65836337534098, 27.9119118019035], [-20.938477970036363, 13.062225186798726, 17.00990003700306, -3.5733869089512], [-3.2690504391174446, -18.335184462464735, -21.73761848043097, 15.86864557759231], [-8.221305238963895, 16.62493326200114, -8.06367456765086, 10.034765425375628]], [[-1.6839458762947697, -15.191304083667264], [-8.681944314276665, 8.397798642626086], [-17.39292967571085, -13.689580715051852], [2.8310693946179906, -11.277978101506353]]]',
    '[[[-1.653832920945927, 14.829639282199656, 20.16339823998985, 7.421737824060686], [-16.088983183506798, 18.60646961295974, -15.053935912426809, -5.970999312016566], [7.588229226529235, 3.638641539726458, -7.72807780216524, 17.50305713451675], [24.53237440772104, 3.4630644726920456, 0.9502975941159101, -2.76527234482839], [-38.1168340748321, -4.715329662268506, 14.59467726260117, 26.15508734847172], [5.371418693462923, -35.84009200663415, 34.13207467233724, -30.87407958419755], [10.793714561531639, 53.034670693870076, 34.65236007228153, -13.467577805845275], [-3.9829905757860784, 6.877824467271388, 25.959113559659308, -12.514231762966054], [6.099446333131308, 0.9786021300091011, 9.115538271655096, -17.73633528706446], [-14.798618918756183, 8.736174687575756, 16.177119076871378, -17.403920464741176], [-4.343988992824206, -4.668567248129082, -11.658418358469726, 43.99212536213281], [13.950607930085722, 22.858508279774608, 1.8376421554289113, 30.888077449519827], [-13.896974477087022, 19.98120399007283, 28.980212435839253, 33.91770018123583], [-35.744653419516844, -17.88578041201962, -12.453270310215496, 27.754912821458042], [-14.236280561830167, 22.16267595223431, 5.4963766430010255, -0.19395976090626155], [-14.068595542944218, -14.472531594282792, -22.170642718937554, 17.37622534343617], [-19.843146890387967, 17.156084009558057, -1.0320748179212802, 0.13123512447543162]], [[-27.289307609768798, -8.59392000777284], [0.058690047340052454, 9.208611190279218], [-10.92401367183309, -11.756234401072774], [11.84033311392973, -24.059185146783754]]]',
    #'[[[11.07567966679078, 14.755595078590845, 31.09514419095994, 13.098801395729973], [-1.5631207165143697, 11.154489811302474, 0.5378375615131147, -12.465672196927983], [19.85038700257495, 7.846280962909448, -19.26060079946796, 18.506494092730126], [18.808402874167445, -10.527883276527572, 24.642299720697483, 29.723865569644495], [-42.04090435070303, 11.656897949223232, 9.195561889575394, 40.279852535419096], [0.07960869769478779, -40.196572217437236, 45.116223883626674, -33.245957082618844], [14.127906789885225, 38.877389802751686, 12.023309678197576, 2.2912823003565896], [2.5479515237985177, 12.957450842791829, 17.8486853843685, -18.445061561649123], [9.444490658969134, -4.8693014569554425, 14.473806884910251, -20.939645251200155], [-11.47345102415833, 8.030322115159734, 15.075510934996762, -3.1215607574371345], [-13.01900621262956, -4.735939916276394, -5.9389812108668, 41.39292349012071], [25.799594500679113, 30.192422830647306, 5.616150551832298, 31.58903704184421], [-0.08532866034735109, 11.893006913076258, 15.677496820043299, 38.961727461915444], [-45.18042428192599, -10.330315846943716, -13.244426897791111, 35.74393501439184], [-11.015080726646339, 33.65287393508378, 18.96114180793542, 0.42011149561356276], [-9.5100071283332, 10.260176230516644, -1.6873724705844215, 11.335319752392088], [-4.522199222455722, 15.356451306051994, -14.176698655315493, 6.265208136025523]], [[-17.19216357154845, -12.596448592636275], [-2.7700313994368395, 19.739074794591854], [-26.87448195184594, -30.56949278334472], [7.306721270898153, -9.95263441092949]]]',
    '[[[12.436207711026734, 19.813199052158318, 41.451261275964775, 7.780285411588835], [-15.04840943274413, 23.195629336142613, 4.248098641163106, -7.085317102663233], [12.291087777608958, 8.493287318109775, -4.355735014673529, 29.707295055973137], [13.744606029238145, -9.988227371691009, 7.366010060334624, 24.318220435470106], [-43.50191029943187, 0.42290526302442033, 3.9693120025827016, 44.899504829231894], [-6.634750841764881, -38.38874852254575, 32.12042292330189, -35.85277920295819], [24.033422208864373, 45.33964500375474, 27.752399061731673, -5.080514490842575], [11.184519530726215, 9.793055845842126, 25.980116855207708, -18.267735947108484], [8.244308176821438, 5.114372242243542, 8.18967785441971, -42.01800094463219], [-25.573267226554822, -17.87707419255912, 4.73886042335903, 0.6724212343285667], [-10.57401803581798, 5.90200776367455, 7.860842496975744, 36.52595241827874], [31.082066784151998, 44.16768708863421, 10.960102185943272, 41.265291566366635], [-22.38053677795859, 19.26672684259185, 19.24721373129088, 35.16542498776993], [-55.24159503313751, -14.933127430120951, 0.8367585907815754, 37.456086641107476], [-14.19885433521131, 33.762379801543695, 27.47574588912674, -0.5272021100828167], [-0.40269576877999214, -1.9769966558395609, -5.474701086483281, 9.71927798958588], [-17.901157736400165, 14.953896095216924, -22.644087164873014, 10.924982906678231]], [[-27.90233619648249, -0.43068333865285713], [-4.3010090026306536, 29.331935031924214], [-22.94228221398682, -34.80657240580969], [9.751064467343411, -6.880693690057349]]]',
]

room_number = 4

def clear_room(c, R, blackboard):
    cx = round(c[0])
    cy = round(c[1])
    #R = round(R*3.7795) #from mm to px
    for x in range(-R, R):
        for y in range( round(-R*sqrt(1-x*x/(R*R))) , round(R*sqrt(1-x*x/(R*R))) ):
            blackboard[ min(blackboard.shape[0]-1, max(0, cx+x)) ][ min(blackboard.shape[1], max(0, cy+y)) ]=1


for i in range(len(vals)):
    weights = json.loads(vals[i])

    env=create_environment(Config.BOARD_SIZE, room_number)
    pygame.init()
    screen = pygame.display.set_mode(config.BOARD_SIZE)
    robot = Robot(config, pygame, screen, config.BOARD_SIZE, env, C.ROBOT_CYAN, [305, 280], 90, config.BALL_SIZE, config.MAX_VELOCITY, weights)
    blackboard=np.zeros(config.BOARD_SIZE, dtype='bool')

    for tick in range(1200): #config.GENERATION_DURATION
        robot.controller_process()
        robot.move()
        clear_room(robot.position, Config.BALL_SIZE, blackboard)
        #update the sensors' measurement
        robot.check_sensors()
        render_environment(screen, pygame, env)
        robot.draw()
        Debug.print_debug_info(screen, "Generation: {:0.0f}".format(i*10+1), (50, 10))
        pygame.display.flip()

    print('Area covered %:', np.count_nonzero(blackboard)*100/(config.BOARD_SIZE[0]*config.BOARD_SIZE[1]),'%')

